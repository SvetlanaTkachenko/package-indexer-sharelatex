#! /usr/bin/env bash

set -euf -o pipefail

_TIMESTAMP=$(date "+%Y%m%d-%H%M%S")
# _INDEXFILE="data/packageIndex_$_TIMESTAMP.json"
_INDEXFILE="data/packageIndex.json"


if [[ ! -e 'build-index.js' || ! -e 'save-index.js' ]];
then
    echo ">> can't find build-index.js or save-index.js, exiting";
    exit 1;
fi;

[[ -z $(docker ps -a -q -f name=index-build-container) ]] && ./bin/create-container;

docker start index-build-container;

docker exec index-build-container bash -c "[[ -e /indexer/package.json ]] && rm -rf /indexer"

docker cp $(pwd) index-build-container:/indexer

docker exec index-build-container \
    bash -c "source ~/.nvm/nvm.sh &&
        nvm use 4.2 &&
        cd /indexer &&
        npm install &&
        echo '>> running build-index.js inside container' &&
        node build-index.js -o $_INDEXFILE"

docker cp "index-build-container:/indexer/data/$_INDEXFILE" ./data/$_INDEXFILE

# node ./save-index.js

echo ">> done"
