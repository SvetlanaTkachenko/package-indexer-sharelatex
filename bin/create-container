#! /usr/bin/env bash


echo ">> creating container to run indexer"

docker create -P \
       --name index-build-container \
       quay.io/sharelatex/datajoy:2015.6

echo ">> starting container after creation"
docker start index-build-container

declare -a expired_keys
expired_keys=($(docker exec index-build-container \
											apt-key list | grep '\[expired:' | awk '{ print $2 }' | sed -E 's/(.*)\/(.*)/\2/'))
if [[ ${#expired_keys[@]} -gt 0 ]];
then
		echo ">> updating expired keys (${expired_keys[@]}) in container"
		docker exec index-build-container \
					 apt-key adv --keyserver keyserver.ubuntu.com --recv-keys "${expired_keys[@]}"
fi;

echo ">> copying into container"
docker cp $(pwd) index-build-container:/indexer

echo '>> install prerequisites in container'
docker exec index-build-container bash -c "apt-get update && apt-get install -y nginx &&
    cp /indexer/resources/nginx.conf /etc/nginx/nginx.conf &&
    mkdir -p /data/nginx &&
    service nginx stop && service nginx start"

echo ">> writing pypi.local entry to hosts file"
docker exec index-build-container bash -c "echo '127.0.1.1	pypi.local' >> /etc/hosts"

echo ">> installing nvm and nodejs"
docker exec index-build-container bash -c "apt-get update && apt-get install -y git &&
    curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.29.0/install.sh | bash &&
    source ~/.nvm/nvm.sh &&
    nvm install 4.2"
